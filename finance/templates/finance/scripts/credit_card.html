<!-- Get credit card -->
<script>
    function get_credit_card_table() {
        $.ajax({
            type: "GET",
            url: "{% url 'finance:credit_card' %}",
            data: {},
            success: function (response) {
                if (response.status) {
                    table_credit_card_finance._options._optionManager._options.dataSource._store._array = response.credit_cards;
                    table_credit_card_finance.refresh();
                } else {
                    toastr.error('Ocorreu um erro inesperado: ' + response.description, 'Erro ao enviar')
                }
                load('off');
            },
            error: function (data) {
                load('off');
                toastr.error('Ocorreu um erro inesperado.', 'Erro ao enviar');
            }
        });
    }

    function get_credit_card_combo(origin) {
        $.ajax({
            type: "GET",
            url: "{% url 'finance:credit_card' %}",
            data: {},
            success: function (response) {
                var combo_box = $("#" + origin);

                combo_box.attr('disabled', false);
                combo_box.find('option').remove().end().append('<option value=0>Selecione</option>');
                $.each(response.credit_cards, function (key, value) {
                    combo_box.append('<option value=' + value.id + '>' + value.name + '</option>');
                });
                load('off');
            },
            error: function (data) {
                load('off');
                toastr.error('Ocorreu um erro inesperado.', 'Erro ao enviar');
            }
        });
    }
</script>

<!-- Update fields on credit card bill modal -->
<script>
    function updateBillEntry() {
        // Inputs
        var input_amount = $("#input_amount_bill_finance");
        var input_dat_purchase = $("#input_dat_purchase_bill_finance");
        var input_dat_payment = $("#input_dat_payment_bill_finance");
        var input_amount_currency = $("#input_amount_currency_bill_finance");
        var input_tax = $("#input_amount_tax_bill_finance");
        var input_exchange_rate = $("#input_exchange_rate_bill_finance");

        // Combo boxes
        var combo_credit_card = $("#combo_creditcard_bill_finance");
        var combo_currency = $("#combo_currency_bill_finance");
        var combo_stallment = $("#combo_stallment_bill_finance");


        if (combo_currency.val() !== 'BRL') {
            input_tax.prop('disabled', false);
            input_exchange_rate.prop('disabled', false);
            input_amount_currency.prop('disabled', false);
        } else {
            input_tax.prop('disabled', true);
            input_tax.maskMoney('mask', 0.00);

            input_exchange_rate.prop('disabled', true);
            input_exchange_rate.maskMoney('mask', 0.00);

            input_amount_currency.prop('disabled', true);
            input_amount_currency.maskMoney('mask', parseFloat(input_amount.val().replace("R$ ", "")));
        }

    }
</script>

<!-- Save the bill entry -->
<script>
    function    set_bill() {
        var amount = $('#input_amount_bill_finance').val() == '' ? 0 : $('#input_amount_bill_finance').val().replace('R$ ', '');
        var amount_currency = $("#input_amount_currency_bill_finance") == '' ? 0 : $("#input_amount_currency_bill_finance").val().replace('R$ ', '');
        var dat_purchase = $('#input_dat_purchase_bill_finance').val();
        var dat_payment = $('#input_dat_payment_bill_finance').val();
        var currency = $("#combo_currency_bill_finance").val();
        var tax = $("#input_amount_tax_bill_finance") == '' ? 0 : $("#input_amount_tax_bill_finance").val().replace('R$ ', '');
        var price_dollar = null;
        var price_currency_dollar = $("#input_price_currency_dollar_rate_bill_finance") == '' ? 0 : $("#input_price_currency_dollar_rate_bill_finance").val().replace('R$ ', '')
        var category_id = $('#combo_category_bill_finance').val();
        var card_id = $('#combo_creditcard_bill_finance').val();
        var description = $('#input_description_bill_finance').val();
        var tot_stallment = $('#combo_stallment_bill_finance').val();

        alert(card_id);
        $.ajax({
            type: "POST",
            url: "{% url 'finance:fatura' %}",
            // url: "#",
            data: {
                'amount': amount,
                'amount_currency': amount_currency,
                'price_dollar': price_dollar,
                'dat_purchase': dat_purchase,
                'dat_payment': dat_payment,
                'currency': currency,
                'amount_tax': tax,
                'price_currency_dollar': price_currency_dollar,
                'description': description,
                'category_id': category_id,
                'card_id': card_id,
                'tot_stallment': tot_stallment,
                'csrfmiddlewaretoken': '{{ csrf_token }}',

            },
            success: function (response) {
                if (response.status === true) {
                    modal.modal('hide');
                    load('off');
                    toastr.success('Você alterou um registro com sucesso!', 'Alteração realizada');
                } else {
                    load('off');
                    toastr.error(response.descricao, 'Erro');
                }
                load('off');
            },
            error: function (data) {
                load('off');
                toastr.error('Ocorreu um erro inesperado.', 'Erro ao enviar');
            }
        });
    }
</script>

<!-- Set the payment date (beta) -->
<script>
    function set_payment_date() {
        $.ajax({
            type: 'GET',
            url: '{% url 'finance:payment_date' %}',
            data: {
                'dat_purchase': $('#input_dat_purchase_bill_entry_finance').val(),
                'credit_card_id': $('#combo_creditcard_bill_entry_finance').val(),
            },
            success: function (response) {
                load('off');
                if (response.status) {
                    $('#input_dat_payment_bill_entry_finance').datepicker("setDate", formatarData(response.dat_payment, "data"));
                } else {
                    toastr.error(response.description);
                }
            },
            error: function (response) {
                load('off');
                toastr.error('Ocorreu um erro inesperado.', 'Erro ao enviar');
            }
        });
    }
</script>

<!-- Add stallments -->
<script>
    function add_stallment(qtd) {

        qtd = parseInt(qtd);


        for (let i = 1; i <= qtd; i++) {
            var div = `<div class="row" id="div_sortable_son_${i}">
                            <p class="col-6">
                                <span class="font-weight-bold">Parcela ${i}:</span>
                                <input type="text" id="add_fatura_vlr_parcela_${i}" tabindex="0" class="form-control currency sortTest">
                            </p>
                            <p class="col-6">
                                <span class="font-weight-bold">Pagamento parcela ${i}:</span>
                                <input type="text" id="add_fatura_dat_parcela_${i}" tabindex="0" class="form-control data sortTest">
                            </p>
                        </div>`

            $("#div_stallments").append(div);
        }

    }
</script>

<!-- Clean credit card bill modal -->
<script>
    function clean_creditcard_bill_modal() {
        // Set amount to default
        $("#input_amount_bill_finance").maskMoney('mask', 0.00);
        $("#input_amount_currency_bill_finance").maskMoney('mask', 0.00);
        $("#input_amount_tax_bill_finance").maskMoney('mask', 0.00);
        $("#input_exchange_rate_bill_finance").maskMoney('mask', 0.00);

        // Set combos to default
        $("#combo_creditcard_bill_finance").val("0").change();
        $("#combo_currency_bill_finance").val("BRL").change();
        $("#combo_stallment_bill_finance").val(1).change();

        // Disble inputs
        $("#input_amount_currency_bill_finance").prop('disabled', true);
        $("#input_amount_tax_bill_finance").prop('disabled', true);
        $("#input_exchange_rate_bill_finance").prop('disabled', true);

        $("#div_stallments").empty();
    }
</script>

